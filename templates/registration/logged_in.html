{% extends "base.html" %}
{% load static %}

{% block title %}Spotify User Profile - Rewindify{% endblock %}

{% block content %}
<div class="d-flex justify-content-center align-items-center vh-100">
    <!-- Scrollable Window -->
    <div class="window-container bg-info text-white rounded shadow-lg p-4 position-relative">

        <!-- Mute Button -->
        <button id="muteButton" class="btn btn-light position-absolute" style="top: 10px; right: 10px;">
            <span id="muteIcon" class="text-dark">ðŸ”Š</span>
        </button>

        <!-- Slideshow Container (Carousel) -->
        <div id="dataCarousel" class="carousel slide" data-bs-ride="carousel">
            <div class="carousel-inner">

                <!-- First Carousel Item - User Profile -->
                <div class="carousel-item active">
                    <p class="display-4 text-primary text-center">Welcome, {{ profile.display_name }}</p>

                    {% if profile.images.0.url %}
                        <div class="text-center">
                            <img src="{{ profile.images.0.url }}" alt="User Profile Image" class="rounded-circle my-4" width="150">
                        </div>
                    {% endif %}

                    <p class="lead text-warning text-center">We are so happy you're here!</p>
                </div>

                <!-- Top Tracks Section -->
                <div class="carousel-item">
                    <h3 class="mt-4 text-primary">Your Top Tracks</h3>
                    <ul class="list-unstyled">
                        {% if top_tracks %}
                            {% for track in top_tracks %}
                                <li class="my-3 text-center">
                                    {% if track.album_image %}
                                        <img src="{{ track.album_image }}" alt="{{ track.name }}" class="rounded my-2" width="100">
                                    {% endif %}
                                    <strong class="text-light">{{ track.name }}</strong>
                                    <span class="text-light">by
                                        {% for artist in track.artists %}
                                            {{ artist }}{% if not loop.last %}, {% endif %}
                                        {% endfor %}
                                    </span>

                                    {% if track.preview_url %}
                                        <div class="mt-2" data-preview-url="{{ track.preview_url }}"></div>
                                    {% endif %}
                                </li>
                            {% endfor %}
                        {% else %}
                            <p class="text-warning">No top tracks found.</p>
                        {% endif %}
                    </ul>
                </div>

                <!-- Top Artists Section -->
                <div class="carousel-item">
                    <h3 class="mt-4 text-primary">Your Top Artists</h3>
                    <ul class="list-unstyled">
                        {% if top_artists %}
                            {% for artist in top_artists %}
                                <li class="my-3 text-center">
                                    {% if artist.images.0.url %}
                                        <img src="{{ artist.images.0.url }}" alt="{{ artist.name }}" class="rounded-circle my-2" width="100">
                                    {% endif %}
                                    <strong class="text-light">{{ artist.name }}</strong>
                                </li>
                            {% endfor %}
                        {% else %}
                            <p class="text-warning">No top artists found.</p>
                        {% endif %}
                    </ul>
                </div>

                <!-- Top Genres Section -->
                <div class="carousel-item">
                    <h3 class="mt-4 text-primary">Your Top Genres</h3>
                    <ul class="list-unstyled">
                        {% if genres %}
                            {% for genre in genres %}
                                <li class="my-3 text-center text-light">
                                    <strong>{{ genre }}</strong>
                                </li>
                            {% endfor %}
                        {% else %}
                            <p class="text-warning">No genres found.</p>
                        {% endif %}
                    </ul>
                </div>

                <!-- Playlists Section -->
                <div class="carousel-item">
                    <h3 class="mt-4 text-primary">Your Playlists</h3>
                    <ul class="list-unstyled">
                        {% if playlists %}
                            {% for playlist in playlists %}
                                <li class="my-3 text-center">
                                    {% if playlist.images.0.url %}
                                        <img src="{{ playlist.images.0.url }}" alt="{{ playlist.name }}" class="rounded my-2" width="100">
                                    {% endif %}
                                    <strong class="text-light">{{ playlist.name }}</strong> - {{ playlist.tracks.total }} tracks
                                </li>
                            {% endfor %}
                        {% else %}
                            <p class="text-warning">No playlists found.</p>
                        {% endif %}
                    </ul>
                </div>

                <!-- Total Minutes Listened Section -->
                <div class="carousel-item">
                    <h3 class="mt-4 text-primary">Total Minutes Listened</h3>
                    <p class="lead text-light">
                        {% if total_minutes %}
                            {{ total_minutes }} minutes
                        {% else %}
                            No listening data available.
                        {% endif %}
                    </p>
                </div>

            </div>

            <!-- Carousel controls with updated buttons -->
            <button class="carousel-control-prev custom-carousel-control" type="button" data-bs-target="#dataCarousel" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden"></span>
            </button>
            <button class="carousel-control-next custom-carousel-control" type="button" data-bs-target="#dataCarousel" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden"></span>
            </button>
        </div>

        <p class="text-center my-3">
            <a href="{{ profile.external_urls.spotify }}" target="_blank" class="btn btn-success">Visit Spotify Profile</a>
        </p>

        <div class="d-flex justify-content-center mt-4">
            <a href="/" class="btn btn-primary mx-2">Back to Home</a>
        </div>
    </div>
</div>

<!-- Hidden audio player -->
<audio id="previewPlayer" style="display: none;"></audio>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const player = document.getElementById('previewPlayer');
    const carousel = document.getElementById('dataCarousel');
    const muteButton = document.getElementById('muteButton');
    const muteIcon = document.getElementById('muteIcon');
    let currentAudio = null;
    let isMuted = false;

    function playRandomPreview() {
        const previewUrls = Array.from(document.querySelectorAll('[data-preview-url]'))
            .map(el => el.dataset.previewUrl)
            .filter(url => url);

        if (previewUrls.length > 0) {
            const randomUrl = previewUrls[Math.floor(Math.random() * previewUrls.length)];
            player.src = randomUrl;
            player.play().catch(e => console.error('Error playing audio:', e));
            currentAudio = randomUrl;
        }
    }

    carousel.addEventListener('slide.bs.carousel', function (e) {
        if (player.src !== currentAudio) {
            player.pause();
            player.currentTime = 0;
        }
        playRandomPreview();
    });

    // Mute/Unmute functionality
    muteButton.addEventListener('click', function() {
        isMuted = !isMuted;
        player.muted = isMuted;
        muteIcon.textContent = isMuted ? 'ðŸ”‡' : 'ðŸ”Š'; // Change icon based on mute status
    });

    // Initial play
    playRandomPreview();
});
</script>
{% block styles %}
<style>
    .carousel {
        position: relative;
    }
    .carousel-control-prev, .carousel-control-next {
        background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent background */
        border-radius: 50%;
        width: 40px;
        height: 40px;
        position: absolute;
        top: 350px; /* Position at the top */
        transform: translateY(0);
        border: none; /* Remove border */
        font-size: 30px; /* Increase font size for larger arrows */
        display: flex;
        justify-content: center;
        align-items: center;
        color: white; /* Text color */
    }
    .carousel-control-prev {
        left: 10px; /* Inside the left edge of the container */
    }
    .carousel-control-next {
        right: 10px; /* Inside the right edge of the container */
    }
    .carousel-control-prev-icon, .carousel-control-next-icon {
        background-color: transparent; /* Remove the default background */
    }
    .carousel-control-prev:hover, .carousel-control-next:hover {
        background-color: rgba(0, 0, 0, 0.7); /* Darker background on hover */
    }
</style>
{% endblock %}

{% endblock %}
